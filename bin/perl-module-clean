#!/bin/bash
set -e
#set -x

PROTECTED_MODULES=(
  "App::cpanminus"
);

perllocalfile=$(perldoc -l perllocal)
if [ -z "$perllocalfile" ]; then
  echo "Could not find perllocal"
  exit 1
fi

_empty_folder_clean() {
  if [ -n "$PERL_LOCAL_LIB_ROOT" ]; then
    find "$PERL_LOCAL_LIB_ROOT" -empty -type d -delete
  fi
}

_remove_perllocal() {
  local module="$1"
  local tmpfile="/tmp/perllocal.pod"

  if [ -z "$module" ]; then
    echo "No module specified for removal"
    return
  fi

  sed -E "/^=head2.+$module>/,/^=back$/{N;d;}" "$perllocalfile" > "$tmpfile"
  echo "Removing $module from perllocal.pod"
  cp "$perllocalfile" "$perllocalfile.backup"
  mv "$tmpfile" "$perllocalfile"
}

_perl_module_clean() {
  for module in $(perl-module-list); do
    local skip=0

    for protected_module in "${PROTECTED_MODULES[@]}"; do
      if [[ "$module" == "$protected_module" ]]; then
        skip=1
        break
      fi
    done

    if [ -z $skip ]; then
      continue;
    fi

    echo "Uninstalling $module..."
    yes | cpanm --uninstall "$module" || true
    _remove_perllocal "$module"
    printf "\n"

  done
}

_perl_module_clean
_empty_folder_clean
