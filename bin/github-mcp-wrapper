#!/usr/bin/env bash

# Wrapper script for GitHub MCP server that fetches token from 1Password
# This script executes the GitHub MCP server with the token injected

set -euo pipefail

# Check if 1Password CLI is available
if ! command -v op &> /dev/null; then
    echo "Error: 1Password CLI (op) is not installed or not in PATH" >&2
    exit 1
fi

# Fetch the GitHub token from 1Password
# Using the exact command pattern the user provided
if ! token=$(op item get --vault=Applications "Github MCP" --fields=password --reveal 2>/dev/null); then
    echo "Error: Failed to fetch GitHub token from 1Password" >&2
    echo "Please ensure:" >&2
    echo "  1. 1Password CLI is authenticated (run 'op signin')" >&2
    echo "  2. The 'Github MCP' item exists in the 'Applications' vault" >&2
    echo "  3. The item has a 'password' field with your GitHub token" >&2
    exit 1
fi

# Validate that we got a token (not empty)
if [[ -z "$token" ]]; then
    echo "Error: Retrieved token is empty" >&2
    exit 1
fi

# Set the token as environment variable and execute the GitHub MCP server
export GITHUB_PERSONAL_ACCESS_TOKEN="$token"

# Execute the GitHub MCP server with the original command
nix run github:NixOS/nixpkgs/nixos-unstable#github-mcp-server -- stdio --read-only
